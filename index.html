<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bedrock Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:'class',theme:{extend:{colors:{bg:'#0c0c0e',surface:{DEFAULT:'#131316',2:'#1a1a1f',3:'#222228',4:'#2a2a32'},border:{DEFAULT:'#27272f',light:'#32323c'},accent:{DEFAULT:'#7c5cfc',hover:'#8b6ffd',dim:'#7c5cfc20'}}}}}</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark-dimmed.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11/highlight.min.js"></script>
<style>
  @keyframes blink{50%{opacity:0}}.cursor-blink{animation:blink 1s step-end infinite}
  @keyframes fadein{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}.fade-in{animation:fadein .15s ease}
  @keyframes spin{to{transform:rotate(360deg)}}.spin{animation:spin .8s linear infinite}
  *::-webkit-scrollbar{width:5px}*::-webkit-scrollbar-thumb{background:#27272f;border-radius:3px}*::-webkit-scrollbar-track{background:transparent}

  .md-content h1,.md-content h2,.md-content h3{font-weight:600;margin:16px 0 8px;color:#f0f0f2}
  .md-content h1{font-size:1.25em}.md-content h2{font-size:1.1em}.md-content h3{font-size:1em}
  .md-content p{margin-bottom:10px}.md-content p:last-child{margin-bottom:0}
  .md-content ul,.md-content ol{margin:8px 0;padding-left:1.5em}.md-content li{margin-bottom:4px}
  .md-content ul{list-style:disc}.md-content ol{list-style:decimal}
  .md-content blockquote{border-left:3px solid #7c5cfc;padding-left:14px;margin:10px 0;color:#9898a6}
  .md-content a{color:#8b6ffd;text-decoration:underline}
  .md-content hr{border-color:#27272f;margin:14px 0}
  .md-content table{border-collapse:collapse;margin:10px 0;width:100%}
  .md-content th,.md-content td{border:1px solid #27272f;padding:8px 12px;text-align:left;font-size:13px}
  .md-content th{background:#1a1a1f;font-weight:600}
  .md-content code:not(pre code){background:#1a1a1f;padding:2px 6px;border-radius:5px;font-size:13px;font-family:'SF Mono','Fira Code','Cascadia Code',monospace;color:#c4b5fd}
  .md-content pre{position:relative;margin:12px 0;border-radius:10px;border:1px solid #27272f;overflow:hidden}
  .md-content pre code{display:block;padding:16px 18px;overflow-x:auto;font-size:13px;line-height:1.6;background:#0d0d12;color:#d4d4d8}
  .code-header{display:flex;justify-content:space-between;align-items:center;padding:6px 14px;background:#141418;border-bottom:1px solid #27272f;font-size:11px;color:#6b6b78}
  .copy-btn{cursor:pointer;padding:3px 10px;border-radius:5px;border:1px solid transparent;background:transparent;color:#6b6b78;font-size:11px;transition:all .15s}
  .copy-btn:hover{border-color:#7c5cfc;color:#e4e4e7}
  .file-chip{display:inline-flex;align-items:center;gap:5px;background:#1a1a1f;border:1px solid #27272f;border-radius:8px;padding:5px 10px;font-size:12px;color:#9898a6}
  .msg-actions{opacity:0;transition:opacity .15s}.message-row:hover .msg-actions{opacity:1}
  .model-option{padding:10px 14px;cursor:pointer;transition:background .1s;font-size:13px;color:#b0b0bc}
  .model-option:hover,.model-option.active{background:#222228;color:#f0f0f2}
</style>
</head>
<body class="h-full bg-bg text-zinc-200 flex overflow-hidden">

<!-- Sidebar -->
<aside class="w-[260px] bg-surface border-r border-border flex flex-col flex-shrink-0 h-full">
  <div class="p-4 flex items-center justify-between">
    <div class="flex items-center gap-2.5">
      <div class="w-8 h-8 rounded-lg bg-accent/20 flex items-center justify-center">
        <svg class="w-4.5 h-4.5 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456z"/></svg>
      </div>
      <span class="text-[15px] font-semibold tracking-tight">Bedrock Chat</span>
    </div>
    <button onclick="newChat()" title="New chat" class="w-8 h-8 rounded-lg flex items-center justify-center text-zinc-500 hover:text-zinc-200 hover:bg-surface-3 transition">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" d="M12 5v14m-7-7h14"/></svg>
    </button>
  </div>
  <div class="px-3 pb-2">
    <button onclick="newChat()" class="w-full flex items-center gap-2.5 px-3 py-2.5 rounded-xl bg-accent/10 text-accent hover:bg-accent/15 transition text-sm font-medium">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M12 5v14m-7-7h14"/></svg>
      New Chat
    </button>
  </div>
  <div id="chat-list" class="flex-1 overflow-y-auto px-2 pb-2 space-y-0.5"></div>
  <div class="p-3 border-t border-border">
    <button onclick="toggleSettings()" class="w-full flex items-center gap-2.5 px-3 py-2.5 rounded-xl text-sm text-zinc-500 hover:text-zinc-300 hover:bg-surface-2 transition">
      <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
      Settings
    </button>
  </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col h-full min-w-0">
  <!-- Top bar -->
  <div class="h-14 border-b border-border flex items-center justify-between px-5 flex-shrink-0">
    <div></div>
    <!-- Model picker button -->
    <button id="model-btn" onclick="toggleModelPicker()" class="flex items-center gap-2 px-3.5 py-2 rounded-xl border border-border hover:border-border-light hover:bg-surface-2 transition text-sm">
      <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
      <span id="model-label" class="text-zinc-300 max-w-[280px] truncate">Select model</span>
      <svg class="w-3.5 h-3.5 text-zinc-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M19 9l-7 7-7-7"/></svg>
    </button>
  </div>

  <!-- Model picker dropdown -->
  <div id="model-picker" class="hidden absolute right-5 top-[60px] z-50 w-[360px] bg-surface-2 border border-border rounded-xl shadow-2xl shadow-black/50 overflow-hidden">
    <div class="p-2.5 border-b border-border">
      <input id="model-search" type="text" placeholder="Search models..." oninput="filterModels()"
        class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm outline-none focus:border-accent transition placeholder:text-zinc-600" />
    </div>
    <div id="model-list" class="max-h-[320px] overflow-y-auto"></div>
  </div>

  <!-- Messages -->
  <div id="messages" class="flex-1 overflow-y-auto scroll-smooth"></div>

  <!-- Attachments -->
  <div id="attachments" class="hidden px-5 pt-2 max-w-[740px] mx-auto w-full">
    <div id="attachment-list" class="flex flex-wrap gap-2"></div>
  </div>

  <!-- Input -->
  <div class="p-4 pb-5 flex-shrink-0">
    <div class="max-w-[740px] mx-auto">
      <div class="flex items-end gap-2 bg-surface-2 border border-border rounded-2xl px-4 py-3 focus-within:border-accent/40 transition shadow-lg shadow-black/10">
        <label title="Attach file" class="flex-shrink-0 cursor-pointer p-2 -ml-1 rounded-xl hover:bg-surface-3 transition text-zinc-500 hover:text-zinc-300">
          <input id="file-input" type="file" multiple class="hidden" onchange="handleFiles(this.files)" />
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
        </label>
        <textarea id="input" rows="1" placeholder="Ask anything..." autofocus
          class="flex-1 bg-transparent text-[15px] outline-none resize-none max-h-44 leading-relaxed font-[inherit] placeholder:text-zinc-600 py-1"></textarea>
        <button id="send-btn" onclick="handleSendClick()" title="Send"
          class="flex-shrink-0 w-9 h-9 rounded-xl flex items-center justify-center transition bg-accent hover:bg-accent-hover text-white">
          <svg id="send-icon" class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
          <svg id="stop-icon" class="w-4 h-4 hidden" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        </button>
      </div>
      <p class="text-center text-[11px] text-zinc-700 mt-2.5">Powered by Amazon Bedrock</p>
    </div>
  </div>
</main>

<!-- Settings Modal -->
<div id="settings-backdrop" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-sm" onclick="toggleSettings()"></div>
<div id="settings" class="hidden fixed z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-surface-2 border border-border rounded-2xl shadow-2xl shadow-black/60">
  <div class="flex items-center justify-between px-6 py-4 border-b border-border">
    <h2 class="text-[15px] font-semibold">Settings</h2>
    <button onclick="toggleSettings()" class="w-8 h-8 rounded-lg flex items-center justify-center text-zinc-500 hover:text-zinc-200 hover:bg-surface-3 transition">&times;</button>
  </div>
  <div class="p-6 space-y-5 max-h-[60vh] overflow-y-auto">
    <label class="block space-y-2">
      <span class="text-sm font-medium text-zinc-300">API Endpoint</span>
      <input id="cfg-endpoint" type="text" placeholder="https://xxx.execute-api.region.amazonaws.com/v1"
        class="w-full bg-surface border border-border rounded-xl px-4 py-2.5 text-sm outline-none focus:border-accent transition placeholder:text-zinc-700" />
    </label>
    <label class="block space-y-2">
      <span class="text-sm font-medium text-zinc-300">API Key</span>
      <input id="cfg-apikey" type="password" placeholder="Your API key"
        class="w-full bg-surface border border-border rounded-xl px-4 py-2.5 text-sm outline-none focus:border-accent transition placeholder:text-zinc-700" />
    </label>
    <label class="block space-y-2">
      <span class="text-sm font-medium text-zinc-300">System Prompt</span>
      <textarea id="cfg-system" rows="3" placeholder="You are a helpful assistant."
        class="w-full bg-surface border border-border rounded-xl px-4 py-2.5 text-sm outline-none focus:border-accent transition placeholder:text-zinc-700 resize-none leading-relaxed"></textarea>
    </label>
    <div class="grid grid-cols-2 gap-4">
      <label class="block space-y-2">
        <span class="text-sm font-medium text-zinc-300">Max Tokens</span>
        <input id="cfg-maxtokens" type="number" value="4096" min="1" max="128000"
          class="w-full bg-surface border border-border rounded-xl px-4 py-2.5 text-sm outline-none focus:border-accent transition" />
      </label>
      <label class="block space-y-2">
        <span class="text-sm font-medium text-zinc-300">Temperature <span id="temp-val" class="text-zinc-500 font-normal">1</span></span>
        <input id="cfg-temp" type="range" min="0" max="1" step="0.05" value="1"
          class="w-full accent-accent mt-3" oninput="$('#temp-val').textContent=this.value" />
      </label>
    </div>
  </div>
  <div class="px-6 py-4 border-t border-border flex justify-end">
    <button onclick="toggleSettings()" class="bg-accent hover:bg-accent-hover text-sm px-5 py-2 rounded-xl transition font-medium">Done</button>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
let chats = JSON.parse(localStorage.getItem('chats') || '[]');
let activeChatId = localStorage.getItem('activeChatId') || null;
let streaming = false;
let abortController = null;
let pendingFiles = [];
let allModels = [];

marked.setOptions({
  highlight: (code, lang) => { try { return lang && hljs.getLanguage(lang) ? hljs.highlight(code,{language:lang}).value : hljs.highlightAuto(code).value; } catch { return code; } },
  breaks: true, gfm: true,
});

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
['endpoint','apikey','system','maxtokens','temp'].forEach(k => {
  const el = $(`#cfg-${k}`), saved = localStorage.getItem(`chat-${k}`);
  if (saved !== null) el.value = saved;
  const p = () => localStorage.setItem(`chat-${k}`, el.value);
  el.addEventListener('change', p); el.addEventListener('input', p);
});
$('#temp-val').textContent = $('#cfg-temp').value;

function getCfg() {
  return {
    endpoint: ($('#cfg-endpoint').value||'').replace(/\/$/,''),
    apiKey: $('#cfg-apikey').value||'',
    model: localStorage.getItem('chat-model')||'global.anthropic.claude-opus-4-6-v1',
    system: $('#cfg-system').value||'',
    maxTokens: parseInt($('#cfg-maxtokens').value)||4096,
    temperature: parseFloat($('#cfg-temp').value),
  };
}

function toggleSettings() { $('#settings').classList.toggle('hidden'); $('#settings-backdrop').classList.toggle('hidden'); }
document.addEventListener('keydown', e => {
  if (e.key==='Escape') {
    if (!$('#settings').classList.contains('hidden')) toggleSettings();
    if (!$('#model-picker').classList.contains('hidden')) closeModelPicker();
  }
});
if (!localStorage.getItem('chat-endpoint')||!localStorage.getItem('chat-apikey')) toggleSettings();

// â”€â”€ Model Picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateModelLabel() {
  const m = localStorage.getItem('chat-model');
  $('#model-label').textContent = m ? m.split('.').pop().replace(/-v\d.*$/,'').replace(/-/g,' ') : 'Select model';
  $('#model-label').title = m || '';
}
updateModelLabel();

function toggleModelPicker() {
  const p = $('#model-picker');
  if (p.classList.contains('hidden')) { p.classList.remove('hidden'); $('#model-search').value=''; filterModels(); $('#model-search').focus(); }
  else closeModelPicker();
}
function closeModelPicker() { $('#model-picker').classList.add('hidden'); }
document.addEventListener('click', e => { if (!$('#model-picker').contains(e.target) && !$('#model-btn').contains(e.target)) closeModelPicker(); });

function selectModel(id) {
  localStorage.setItem('chat-model', id);
  updateModelLabel(); closeModelPicker();
}

function filterModels() {
  const q = $('#model-search').value.toLowerCase();
  const filtered = allModels.filter(m => m.toLowerCase().includes(q));
  const current = localStorage.getItem('chat-model');
  const list = $('#model-list');
  list.innerHTML = '';
  if (!filtered.length) { list.innerHTML = '<div class="p-4 text-center text-sm text-zinc-600">No models found</div>'; return; }
  filtered.forEach(id => {
    const d = document.createElement('div');
    d.className = `model-option ${id===current?'active bg-surface-3':''}`;
    // Pretty name
    const parts = id.split('.');
    const provider = parts.length > 1 ? parts.slice(0,-1).join('.') : '';
    const name = parts.pop().replace(/-v\d.*$/,'').replace(/-/g,' ');
    d.innerHTML = `<div class="font-medium text-[13px] ${id===current?'text-accent':'text-zinc-300'}">${esc(name)}</div>
      <div class="text-[11px] text-zinc-600 mt-0.5 truncate">${esc(id)}</div>`;
    d.onclick = () => selectModel(id);
    list.appendChild(d);
  });
}

async function fetchModels() {
  const { endpoint, apiKey } = getCfg();
  if (!endpoint || !apiKey) return;
  try {
    const res = await fetch(`${endpoint}/models`, { headers: { 'Authorization': `Bearer ${apiKey}` } });
    if (!res.ok) throw new Error();
    const json = await res.json();
    allModels = (json.data||[]).map(m => m.id).sort();
    if (!localStorage.getItem('chat-model') && allModels.length) {
      localStorage.setItem('chat-model', allModels.find(m=>m.includes('opus-4-6'))||allModels.find(m=>m.includes('claude'))||allModels[0]);
    }
    updateModelLabel();
  } catch { console.error('Failed to fetch models'); }
}

// â”€â”€ Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFiles(fl) {
  for (const f of fl) {
    const r = new FileReader();
    if (f.type.startsWith('image/')) { r.onload=()=>{pendingFiles.push({name:f.name,content:r.result,type:'image'});renderAttachments();}; r.readAsDataURL(f); }
    else { r.onload=()=>{pendingFiles.push({name:f.name,content:r.result,type:'text'});renderAttachments();}; r.readAsText(f); }
  }
  $('#file-input').value='';
}
function removeFile(i){pendingFiles.splice(i,1);renderAttachments();}
function renderAttachments(){
  const c=$('#attachment-list'),w=$('#attachments');
  if(!pendingFiles.length){w.classList.add('hidden');c.innerHTML='';return;}
  w.classList.remove('hidden');
  c.innerHTML=pendingFiles.map((f,i)=>`<div class="file-chip">${f.type==='image'?'ðŸ–¼':'ðŸ“„'} ${esc(f.name)}<button onclick="removeFile(${i})" class="ml-1 text-zinc-600 hover:text-red-400 text-sm">&times;</button></div>`).join('');
}
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',e=>{e.preventDefault();if(e.dataTransfer.files.length)handleFiles(e.dataTransfer.files);});

// â”€â”€ Chats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveChats(){localStorage.setItem('chats',JSON.stringify(chats));localStorage.setItem('activeChatId',activeChatId);}
function getChat(){return chats.find(c=>c.id===activeChatId)||null;}

function newChat(){
  // Auto-title the previous chat before switching
  autoTitleChat(getChat());
  const chat={id:crypto.randomUUID(),title:'New chat',messages:[],created:Date.now()};
  chats.unshift(chat);activeChatId=chat.id;
  saveChats();renderChatList();renderMessages();$('#input').focus();
}
function deleteChat(id,e){
  e.stopPropagation();chats=chats.filter(c=>c.id!==id);
  if(activeChatId===id)activeChatId=chats[0]?.id||null;
  saveChats();renderChatList();renderMessages();
}
function selectChat(id){
  if(id===activeChatId)return;
  autoTitleChat(getChat());
  activeChatId=id;saveChats();renderChatList();renderMessages();
}

function autoTitleChat(chat) {
  if (!chat || chat.title !== 'New chat' || chat.messages.length < 2) return;
  const userMsgs = chat.messages.filter(m => m.role === 'user');
  const assistantMsgs = chat.messages.filter(m => m.role === 'assistant');
  if (!userMsgs.length) return;
  // Generate title from first user message + first few words of assistant response
  const firstQ = userMsgs[0].content.slice(0, 60).replace(/\n/g, ' ');
  if (firstQ.length > 40) { chat.title = firstQ.slice(0, 40) + 'â€¦'; }
  else { chat.title = firstQ; }
  // If we have an assistant response, try to make a smarter title
  if (assistantMsgs.length) {
    const answer = assistantMsgs[0].content.slice(0, 200);
    // Extract first sentence or meaningful phrase
    const match = answer.match(/^(?:#+ )?(.{10,60}?)(?:[.!?\n]|$)/);
    if (match) {
      const candidate = match[1].replace(/^[#*\s]+/, '').trim();
      if (candidate.length > 10) chat.title = candidate.slice(0, 45) + (candidate.length > 45 ? 'â€¦' : '');
    }
  }
  saveChats(); renderChatList();
}

function renderChatList(){
  const el=$('#chat-list');el.innerHTML='';
  chats.forEach(chat=>{
    const d=document.createElement('div');
    d.className=`group flex items-center gap-2 px-3 py-2.5 rounded-xl cursor-pointer transition text-sm ${chat.id===activeChatId?'bg-surface-3 text-zinc-100':'text-zinc-500 hover:bg-surface-2 hover:text-zinc-300'}`;
    d.onclick=()=>selectChat(chat.id);
    d.innerHTML=`<svg class="w-4 h-4 flex-shrink-0 ${chat.id===activeChatId?'text-accent':'text-zinc-600'}" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z"/></svg>
      <span class="flex-1 truncate">${esc(chat.title)}</span>
      <button onclick="deleteChat('${chat.id}',event)" class="hidden group-hover:flex w-6 h-6 items-center justify-center rounded-md text-zinc-600 hover:text-red-400 hover:bg-surface-4 transition text-xs">âœ•</button>`;
    el.appendChild(d);
  });
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function renderMarkdown(text){
  const html=marked.parse(text);
  const w=document.createElement('div');w.innerHTML=html;
  w.querySelectorAll('pre').forEach(pre=>{
    const code=pre.querySelector('code');
    const lang=code?.className?.match(/language-(\w+)/)?.[1]||'';
    const hdr=document.createElement('div');hdr.className='code-header';
    hdr.innerHTML=`<span>${lang||'code'}</span><button class="copy-btn" onclick="copyCode(this)">Copy</button>`;
    pre.insertBefore(hdr,pre.firstChild);
  });
  return w.innerHTML;
}
function copyCode(btn){navigator.clipboard.writeText(btn.closest('pre').querySelector('code').textContent);btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy',1500);}

function renderMessages(){
  const chat=getChat(),el=$('#messages');el.innerHTML='';
  if(!chat||!chat.messages.filter(m=>m.role!=='system').length){
    el.innerHTML=`<div class="h-full flex flex-col items-center justify-center gap-4">
      <div class="w-16 h-16 rounded-2xl bg-accent/10 flex items-center justify-center">
        <svg class="w-8 h-8 text-accent/60" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
      </div>
      <div class="text-center"><p class="text-zinc-400 text-[15px] font-medium">How can I help you?</p><p class="text-zinc-600 text-sm mt-1">Ask anything or attach a file to get started</p></div></div>`;
    return;
  }
  chat.messages.forEach((msg,idx)=>{if(msg.role==='system')return;appendMessageEl(msg.role,msg.content,msg.files,idx);});
  el.scrollTop=el.scrollHeight;
}

function appendMessageEl(role,text,files,msgIdx){
  const el=$('#messages');
  const empty=el.querySelector('.flex.flex-col.items-center');if(empty)empty.remove();
  const row=document.createElement('div');
  row.className=`message-row py-5 fade-in ${role==='assistant'?'bg-surface/60':''}`;
  row.dataset.idx=msgIdx??'';

  const inner=document.createElement('div');
  inner.className='max-w-[740px] mx-auto px-5 flex gap-4';

  const avatar=document.createElement('div');
  avatar.className=`w-8 h-8 rounded-xl flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5 ${role==='user'?'bg-accent text-white':'bg-surface-3 text-zinc-400 border border-border'}`;
  avatar.textContent=role==='user'?'U':'AI';

  const content=document.createElement('div');
  content.className='flex-1 min-w-0';

  if(files?.length){
    const fd=document.createElement('div');fd.className='flex flex-wrap gap-2 mb-3';
    files.forEach(f=>{
      if(f.type==='image'){const img=document.createElement('img');img.src=f.content;img.className='max-w-[220px] max-h-40 rounded-xl border border-border';img.alt=f.name;fd.appendChild(img);}
      else{const c=document.createElement('span');c.className='file-chip';c.textContent=`ðŸ“„ ${f.name}`;fd.appendChild(c);}
    });
    content.appendChild(fd);
  }

  const textDiv=document.createElement('div');
  textDiv.className='text-[14px] leading-[1.7] break-words';
  if(role==='assistant'){textDiv.className+=' md-content';textDiv.innerHTML=renderMarkdown(text);}
  else{textDiv.className+=' whitespace-pre-wrap text-zinc-300';textDiv.textContent=text;}
  content.appendChild(textDiv);

  if(msgIdx!==undefined&&!streaming){
    const actions=document.createElement('div');
    actions.className='msg-actions mt-2 flex gap-1';
    if(role==='user'){
      actions.innerHTML=`<button onclick="editMessage(${msgIdx})" class="text-xs text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded-lg hover:bg-surface-3 transition flex items-center gap-1">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/></svg> Edit</button>`;
    }
    if(role==='assistant'){
      actions.innerHTML=`<button onclick="copyMessage(${msgIdx})" class="text-xs text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded-lg hover:bg-surface-3 transition flex items-center gap-1">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/></svg> Copy</button>
        <button onclick="regenerate(${msgIdx})" class="text-xs text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded-lg hover:bg-surface-3 transition flex items-center gap-1">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"/></svg> Regenerate</button>`;
    }
    content.appendChild(actions);
  }

  inner.appendChild(avatar);inner.appendChild(content);
  row.appendChild(inner);el.appendChild(row);
  el.scrollTop=el.scrollHeight;
  return textDiv;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editMessage(idx){
  const chat=getChat();if(!chat)return;
  const msg=chat.messages[idx];if(msg.role!=='user')return;
  $('#input').value=msg.content;$('#input').focus();
  $('#input').style.height='auto';$('#input').style.height=Math.min($('#input').scrollHeight,160)+'px';
  chat.messages=chat.messages.slice(0,idx);
  saveChats();renderMessages();
}
function copyMessage(idx){const chat=getChat();if(chat)navigator.clipboard.writeText(chat.messages[idx].content);}
function regenerate(idx){
  const chat=getChat();if(!chat||streaming)return;
  chat.messages=chat.messages.slice(0,idx);
  saveChats();renderMessages();doStream(chat);
}

// â”€â”€ Send / Stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const inputEl=$('#input');
inputEl.addEventListener('input',()=>{inputEl.style.height='auto';inputEl.style.height=Math.min(inputEl.scrollHeight,176)+'px';});
inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendClick();}});
inputEl.addEventListener('paste',e=>{const items=e.clipboardData?.items;if(!items)return;for(const item of items){if(item.type.startsWith('image/')){e.preventDefault();handleFiles([item.getAsFile()]);}}});

function handleSendClick(){if(streaming)stopStreaming();else send();}
function setStreamingUI(on){streaming=on;$('#send-icon').classList.toggle('hidden',on);$('#stop-icon').classList.toggle('hidden',!on);$('#send-btn').classList.toggle('bg-accent',!on);$('#send-btn').classList.toggle('bg-red-600',on);$('#send-btn').classList.toggle('hover:bg-accent-hover',!on);$('#send-btn').classList.toggle('hover:bg-red-500',on);}
function stopStreaming(){if(abortController){abortController.abort();abortController=null;}}

async function send(){
  const text=inputEl.value.trim();
  if(!text&&!pendingFiles.length)return;
  const{endpoint,apiKey,system}=getCfg();
  if(!endpoint||!apiKey){toggleSettings();return;}
  if(!getChat())newChat();
  const chat=getChat();
  if(chat.messages.length===0&&system)chat.messages.push({role:'system',content:system});

  let userContent=text;const msgFiles=[...pendingFiles];
  if(msgFiles.length){
    const tp=msgFiles.filter(f=>f.type==='text').map(f=>`--- ${f.name} ---\n${f.content}\n--- end ---`);
    const ip=msgFiles.filter(f=>f.type==='image').map(f=>`[Image: ${f.name}]`);
    userContent=[...ip,...tp,text].filter(Boolean).join('\n\n');
  }

  chat.messages.push({role:'user',content:userContent,files:msgFiles.length?msgFiles:undefined});
  if(chat.messages.filter(m=>m.role==='user').length===1)chat.title=(text||msgFiles[0]?.name||'New chat').slice(0,50);
  saveChats();renderChatList();
  appendMessageEl('user',text||'(files attached)',msgFiles,chat.messages.length-1);

  inputEl.value='';inputEl.style.height='auto';
  pendingFiles=[];renderAttachments();
  await doStream(chat);
}

async function doStream(chat){
  const{endpoint,apiKey,model,maxTokens,temperature}=getCfg();
  setStreamingUI(true);
  const contentEl=appendMessageEl('assistant','',null,chat.messages.length);
  const cursor=document.createElement('span');
  cursor.className='inline-block w-0.5 h-4 bg-accent cursor-blink align-text-bottom ml-px';
  contentEl.appendChild(cursor);

  let fullText='';abortController=new AbortController();
  try{
    const apiMessages=chat.messages.map(m=>({role:m.role,content:m.content}));
    const res=await fetch(`${endpoint}/chat/completions`,{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},
      body:JSON.stringify({model,messages:apiMessages,max_tokens:maxTokens,temperature,stream:true}),
      signal:abortController.signal,
    });
    if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error?.message||`HTTP ${res.status}`);}
    const reader=res.body.getReader();const decoder=new TextDecoder();let buffer='';
    while(true){
      const{done,value}=await reader.read();if(done)break;
      buffer+=decoder.decode(value,{stream:true});const lines=buffer.split('\n');buffer=lines.pop();
      for(const line of lines){
        if(!line.startsWith('data: '))continue;const data=line.slice(6);if(data==='[DONE]')break;
        try{const delta=JSON.parse(data).choices?.[0]?.delta?.content;
          if(delta){fullText+=delta;contentEl.innerHTML=renderMarkdown(fullText);contentEl.appendChild(cursor);$('#messages').scrollTop=$('#messages').scrollHeight;}
        }catch{}
      }
    }
  }catch(err){
    if(err.name!=='AbortError'){contentEl.textContent=`Error: ${err.message}`;contentEl.classList.add('text-red-400');cursor.remove();setStreamingUI(false);return;}
  }
  cursor.remove();
  if(fullText){contentEl.innerHTML=renderMarkdown(fullText);chat.messages.push({role:'assistant',content:fullText});saveChats();}
  setStreamingUI(false);abortController=null;inputEl.focus();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderChatList();
if(activeChatId)renderMessages();
if(localStorage.getItem('chat-endpoint')&&localStorage.getItem('chat-apikey'))fetchModels();
</script>
</body>
</html>
