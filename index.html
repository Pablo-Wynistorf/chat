<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:'class',theme:{extend:{colors:{bg:'#0c0c0e',surface:{DEFAULT:'#131316',2:'#1a1a1f',3:'#222228',4:'#2a2a32'},border:{DEFAULT:'#27272f',light:'#32323c'},accent:{DEFAULT:'#7c5cfc',hover:'#8b6ffd'}}}}}</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark-dimmed.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11/highlight.min.js"></script>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https:; img-src 'self' data: blob:;">
<style>
  @keyframes blink{50%{opacity:0}}.cursor-blink{animation:blink 1s step-end infinite}
  @keyframes fadein{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}.fade-in{animation:fadein .15s ease}
  *::-webkit-scrollbar{width:5px}*::-webkit-scrollbar-thumb{background:#27272f;border-radius:3px}
  .md-content h1,.md-content h2,.md-content h3{font-weight:600;margin:14px 0 6px;color:#f0f0f2}
  .md-content h1{font-size:1.2em}.md-content h2{font-size:1.05em}.md-content h3{font-size:.95em}
  .md-content p{margin-bottom:8px}.md-content p:last-child{margin-bottom:0}
  .md-content ul,.md-content ol{margin:6px 0;padding-left:1.5em}.md-content li{margin-bottom:3px}
  .md-content ul{list-style:disc}.md-content ol{list-style:decimal}
  .md-content blockquote{border-left:3px solid #7c5cfc;padding-left:12px;margin:8px 0;color:#9898a6}
  .md-content a{color:#818cf8;text-decoration:underline}
  .md-content table{border-collapse:collapse;margin:8px 0;width:100%}
  .md-content th,.md-content td{border:1px solid #27272f;padding:6px 10px;text-align:left;font-size:13px}
  .md-content th{background:#1a1a1f;font-weight:600}
  .md-content code:not(pre code){background:#1a1a1f;padding:2px 5px;border-radius:4px;font-size:13px;font-family:'SF Mono','Fira Code',monospace;color:#c4b5fd}
  .md-content pre{position:relative;margin:10px 0;border-radius:8px;border:1px solid #27272f;overflow:hidden}
  .md-content pre code{display:block;padding:14px 16px;overflow-x:auto;font-size:13px;line-height:1.6;background:#0d0d12;color:#d4d4d8}
  .code-header{display:flex;justify-content:space-between;align-items:center;padding:5px 12px;background:#141418;border-bottom:1px solid #27272f;font-size:11px;color:#6b6b78;position:sticky;top:0;z-index:5}
  .copy-btn{cursor:pointer;padding:3px 10px;border-radius:5px;border:1px solid transparent;background:transparent;color:#6b6b78;font-size:11px;transition:all .15s;position:relative;z-index:6}
  .copy-btn:hover{border-color:#7c5cfc;color:#e4e4e7}
  .file-chip{display:inline-flex;align-items:center;gap:5px;background:#1a1a1f;border:1px solid #27272f;border-radius:8px;padding:5px 10px;font-size:12px;color:#9898a6}
  .msg-actions{opacity:0;transition:opacity .15s}.message-row:hover .msg-actions,.message-row:active .msg-actions{opacity:1}
  .model-option{padding:10px 14px;cursor:pointer;transition:background .1s;font-size:13px;color:#b0b0bc}
  .model-option:hover,.model-option.active{background:#222228;color:#f0f0f2}
  .tip-wrap{position:relative;display:inline-flex}
  .tip-icon{display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:#222228;color:#6b6b78;font-size:9px;cursor:default;flex-shrink:0;user-select:none}
  .tip-text{display:none;position:absolute;left:50%;top:calc(100% + 6px);transform:translateX(-50%);background:#1a1a1f;border:1px solid #32323c;color:#b0b0bc;font-size:11.5px;line-height:1.5;padding:7px 11px;border-radius:8px;width:220px;z-index:999;box-shadow:0 8px 20px rgba(0,0,0,.5);white-space:normal;pointer-events:none}
  .tip-wrap:hover .tip-text{display:block}
  @media(max-width:640px){.tip-text{left:0;transform:none}}
  /* Scroll-to-bottom button */
  .scroll-bottom-btn{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);z-index:10;background:#222228;border:1px solid #32323c;color:#b0b0bc;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4);transition:all .15s;opacity:0;pointer-events:none}
  .scroll-bottom-btn.visible{opacity:1;pointer-events:auto}
  .scroll-bottom-btn:hover{background:#2a2a32;color:#f0f0f2;border-color:#7c5cfc}
  /* Continue generating button */
  .continue-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:10px;border:1px solid #32323c;background:#1a1a1f;color:#b0b0bc;font-size:12px;cursor:pointer;transition:all .15s;margin-top:8px}
  .continue-btn:hover{border-color:#7c5cfc;color:#f0f0f2;background:#222228}
</style>
</head>
<body class="h-full bg-bg text-zinc-200 flex overflow-hidden">
<script>
  // SPA redirect: restore path from ?p= query param set by 404.html
  (function(){var q=new URLSearchParams(location.search).get('p');if(q){history.replaceState(null,'',q);}})();
</script>

<!-- Mobile sidebar toggle -->
<button id="sidebar-toggle" onclick="toggleSidebar()" class="fixed top-3 left-3 z-30 w-9 h-9 rounded-lg bg-surface-2 border border-border flex items-center justify-center text-zinc-400 hover:text-zinc-200 sm:hidden transition">
  <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
</button>

<!-- Sidebar -->
<aside id="sidebar" class="w-[260px] bg-surface border-r border-border flex flex-col flex-shrink-0 h-full fixed sm:relative z-20 -translate-x-full sm:translate-x-0 transition-transform">
  <div class="p-4 flex items-center justify-center gap-2.5">
    <div class="w-8 h-8 rounded-lg bg-accent/20 flex items-center justify-center flex-shrink-0">
      <svg class="w-[18px] h-[18px] text-accent" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"/></svg>
    </div>
    <span class="text-[15px] font-semibold tracking-tight">AI Chat</span>
  </div>
  <div class="px-3 pb-2">
    <button onclick="newChat()" class="w-full flex items-center gap-2.5 px-3 py-2.5 rounded-xl bg-accent/10 text-accent hover:bg-accent/15 transition text-sm font-medium">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M12 5v14m-7-7h14"/></svg>
      New Chat
    </button>
  </div>
  <div id="chat-list" class="flex-1 overflow-y-auto px-2 pb-2 space-y-0.5"></div>
  <div class="p-3 border-t border-border">
    <button onclick="toggleSettings()" class="w-full flex items-center gap-2.5 px-3 py-2.5 rounded-xl text-sm text-zinc-500 hover:text-zinc-300 hover:bg-surface-2 transition">
      <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
      Settings
    </button>
  </div>
</aside>
<div id="sidebar-overlay" class="hidden fixed inset-0 z-10 bg-black/40 sm:hidden" onclick="toggleSidebar()"></div>

<!-- Main -->
<main class="flex-1 flex flex-col h-full min-w-0">
  <!-- Top bar -->
  <div class="h-12 border-b border-border flex items-center justify-end px-4 pl-14 sm:pl-4 flex-shrink-0">
    <button id="model-btn" onclick="toggleModelPicker()" class="flex items-center gap-2 px-3 py-1.5 rounded-xl border border-border hover:border-border-light hover:bg-surface-2 transition text-sm max-w-[70vw]">
      <svg class="w-4 h-4 text-accent flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
      <span id="model-label" class="text-zinc-300 truncate">Select model</span>
      <svg class="w-3 h-3 text-zinc-500 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M19 9l-7 7-7-7"/></svg>
    </button>
  </div>

  <!-- Model picker -->
  <div id="model-picker" class="hidden absolute right-4 top-[52px] z-50 w-[340px] max-w-[90vw] bg-surface-2 border border-border rounded-xl shadow-2xl shadow-black/50 overflow-hidden">
    <div class="p-2.5 border-b border-border">
      <input id="model-search" type="text" placeholder="Search models..." oninput="filterModels()"
        class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm outline-none focus:border-accent transition placeholder:text-zinc-600" />
    </div>
    <div id="model-list" class="max-h-[280px] overflow-y-auto"></div>
  </div>

  <!-- Messages wrapper (relative for scroll button) -->
  <div class="flex-1 relative min-h-0">
    <div id="messages" class="h-full overflow-y-auto scroll-smooth"></div>
    <button id="scroll-bottom-btn" class="scroll-bottom-btn" onclick="scrollToBottomAndAttach()" title="Scroll to bottom">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
    </button>
  </div>

  <!-- Attachments -->
  <div id="attachments" class="hidden px-4 pt-2 max-w-[740px] mx-auto w-full">
    <div id="attachment-list" class="flex flex-wrap gap-2"></div>
  </div>

  <!-- Input -->
  <div class="p-3 sm:p-4 flex-shrink-0">
    <div class="max-w-[740px] mx-auto">
      <div class="flex items-center gap-2 bg-surface-2 border border-border rounded-2xl px-3 py-2.5 focus-within:border-accent/40 transition shadow-lg shadow-black/10">
        <label title="Attach" class="flex-shrink-0 cursor-pointer p-1.5 rounded-xl hover:bg-surface-3 transition text-zinc-500 hover:text-zinc-300">
          <input id="file-input" type="file" multiple class="hidden" onchange="handleFiles(this.files)" />
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
        </label>
        <textarea id="input" rows="1" placeholder="Ask anything..." autofocus
          class="flex-1 bg-transparent text-[15px] outline-none resize-none max-h-40 leading-relaxed font-[inherit] placeholder:text-zinc-600 self-center"></textarea>
        <button id="send-btn" onclick="handleSendClick()"
          class="flex-shrink-0 w-9 h-9 rounded-xl flex items-center justify-center transition bg-accent hover:bg-accent-hover text-white">
          <svg id="send-icon" class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          <svg id="stop-icon" class="w-4 h-4 hidden" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        </button>
      </div>
      <p class="text-center text-[11px] text-zinc-700 mt-2">Powered by Amazon Bedrock</p>
    </div>
  </div>
</main>

<!-- Delete Chat Confirm -->
<div id="delete-backdrop" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-sm" onclick="cancelDelete()"></div>
<div id="delete-modal" class="hidden fixed z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-sm bg-surface-2 border border-border rounded-2xl shadow-2xl shadow-black/60 p-6">
  <h3 class="text-[15px] font-semibold mb-2">Delete chat?</h3>
  <p class="text-sm text-zinc-400 mb-5">This will permanently delete this conversation.</p>
  <div class="flex justify-end gap-2">
    <button onclick="cancelDelete()" class="px-4 py-2 rounded-xl text-sm text-zinc-400 hover:text-zinc-200 hover:bg-surface-3 transition">Cancel</button>
    <button onclick="confirmDelete()" class="px-4 py-2 rounded-xl text-sm bg-red-600 hover:bg-red-500 text-white transition font-medium">Delete</button>
  </div>
</div>

<!-- Delete ALL Chats Confirm -->
<div id="delete-all-backdrop" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-sm" onclick="cancelDeleteAll()"></div>
<div id="delete-all-modal" class="hidden fixed z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-sm bg-surface-2 border border-border rounded-2xl shadow-2xl shadow-black/60 p-6">
  <h3 class="text-[15px] font-semibold mb-2">Delete all chats?</h3>
  <p class="text-sm text-zinc-400 mb-5">This will permanently delete all conversations. This action cannot be undone.</p>
  <div class="flex justify-end gap-2">
    <button onclick="cancelDeleteAll()" class="px-4 py-2 rounded-xl text-sm text-zinc-400 hover:text-zinc-200 hover:bg-surface-3 transition">Cancel</button>
    <button onclick="confirmDeleteAll()" class="px-4 py-2 rounded-xl text-sm bg-red-600 hover:bg-red-500 text-white transition font-medium">Delete All</button>
  </div>
</div>

<!-- Settings -->
<div id="settings-backdrop" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-sm" onclick="toggleSettings()"></div>
<div id="settings" class="hidden fixed z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[92vw] max-w-md bg-surface-2 border border-border rounded-2xl shadow-2xl shadow-black/60 flex flex-col max-h-[95vh]">
  <div class="flex items-center justify-between px-5 py-3 border-b border-border flex-shrink-0">
    <h2 class="text-sm font-semibold">Settings</h2>
    <button onclick="toggleSettings()" class="w-8 h-8 rounded-lg flex items-center justify-center text-zinc-500 hover:text-zinc-200 hover:bg-surface-3 transition">&times;</button>
  </div>
  <div class="p-5 space-y-3 overflow-y-auto">
    <div class="space-y-1">
      <div class="flex items-center gap-1.5 text-sm font-medium text-zinc-300">API Endpoint
        <span class="tip-wrap"><span class="tip-icon">?</span><span class="tip-text">Base URL of your gateway, e.g. https://xxx.execute-api.region.amazonaws.com/v1</span></span>
      </div>
      <input id="cfg-endpoint" type="text" placeholder="https://xxx.execute-api.region.amazonaws.com/v1"
        class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm outline-none focus:border-accent transition placeholder:text-zinc-700" />
    </div>
    <div class="space-y-1">
      <div class="flex items-center gap-1.5 text-sm font-medium text-zinc-300">API Key
        <span class="tip-wrap"><span class="tip-icon">?</span><span class="tip-text">Secret key for auth. Sent as Bearer token.</span></span>
      </div>
      <input id="cfg-apikey" type="password" placeholder="Your API key"
        class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm outline-none focus:border-accent transition placeholder:text-zinc-700" />
    </div>
    <div class="space-y-1">
      <div class="flex items-center gap-1.5 text-sm font-medium text-zinc-300">System Prompt
        <span class="tip-wrap"><span class="tip-icon">?</span><span class="tip-text">Instructions at the start of every chat. Set behavior or constraints.</span></span>
      </div>
      <textarea id="cfg-system" rows="2" placeholder="You are a helpful assistant."
        class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm outline-none focus:border-accent transition placeholder:text-zinc-700 resize-none leading-relaxed"></textarea>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div class="space-y-1">
        <div class="flex items-center gap-1.5 text-sm font-medium text-zinc-300">Max Tokens <span class="text-zinc-500 font-normal text-xs" id="tokens-val">4096</span>
          <span class="tip-wrap"><span class="tip-icon">?</span><span class="tip-text">Max response length. Higher = longer answers. Limit: 65,536.</span></span>
        </div>
        <input id="cfg-maxtokens" type="range" min="256" max="65536" step="256" value="4096"
          class="w-full accent-accent" oninput="$('#tokens-val').textContent=this.value" />
        <div class="flex justify-between text-[10px] text-zinc-600"><span>256</span><span>65k</span></div>
      </div>
      <div class="space-y-1">
        <div class="flex items-center gap-1.5 text-sm font-medium text-zinc-300">Temp <span class="text-zinc-500 font-normal text-xs" id="temp-val">1</span>
          <span class="tip-wrap"><span class="tip-icon">?</span><span class="tip-text">0 = precise, 1 = creative. Lower for code, higher for writing.</span></span>
        </div>
        <input id="cfg-temp" type="range" min="0" max="1" step="0.05" value="1"
          class="w-full accent-accent" oninput="$('#temp-val').textContent=this.value" />
        <div class="flex justify-between text-[10px] text-zinc-600"><span>Precise</span><span>Creative</span></div>
      </div>
    </div>
    <!-- Danger zone: Delete all chats -->
    <div class="pt-3 mt-2 border-t border-border">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm font-medium text-zinc-300">Delete all chats</div>
          <div class="text-xs text-zinc-600 mt-0.5">Permanently remove all conversations</div>
        </div>
        <button onclick="showDeleteAllModal()" class="px-4 py-2 rounded-xl text-sm bg-red-600/10 text-red-400 hover:bg-red-600/20 hover:text-red-300 border border-red-600/20 transition font-medium">Delete All</button>
      </div>
    </div>
  </div>
  <div class="px-5 py-3 border-t border-border flex justify-end flex-shrink-0">
    <button onclick="toggleSettings()" class="bg-accent hover:bg-accent-hover text-sm px-5 py-1.5 rounded-xl transition font-medium">Done</button>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
let chats=JSON.parse(localStorage.getItem('chats')||'[]');
let activeChatId=localStorage.getItem('activeChatId')||null;
let streaming=false,abortController=null,pendingFiles=[],allModels=[],pendingDeleteId=null;
let userScrolledAway=false,autoScrollEnabled=true;
let lastStopReason=null; // track if generation stopped due to token limit

marked.setOptions({highlight:(code,lang)=>{try{return lang&&hljs.getLanguage(lang)?hljs.highlight(code,{language:lang}).value:hljs.highlightAuto(code).value}catch{return code}},breaks:true,gfm:true});

// â”€â”€ Scroll tracking â”€â”€
const messagesEl=$('#messages');
messagesEl.addEventListener('scroll',()=>{
  if(!streaming){updateScrollBtn();return;}
  const atBottom=messagesEl.scrollHeight-messagesEl.scrollTop-messagesEl.clientHeight<80;
  if(!atBottom){userScrolledAway=true;autoScrollEnabled=false;}
  updateScrollBtn();
});
function updateScrollBtn(){
  const atBottom=messagesEl.scrollHeight-messagesEl.scrollTop-messagesEl.clientHeight<80;
  const btn=$('#scroll-bottom-btn');
  if(atBottom){btn.classList.remove('visible');}
  else{btn.classList.add('visible');}
}
function scrollToBottomAndAttach(){
  autoScrollEnabled=true;userScrolledAway=false;
  messagesEl.scrollTop=messagesEl.scrollHeight;
  updateScrollBtn();
}

// â”€â”€ Config â”€â”€
['endpoint','apikey','system','maxtokens','temp'].forEach(k=>{
  const el=$(`#cfg-${k}`),saved=localStorage.getItem(`chat-${k}`);
  if(saved!==null)el.value=saved;
  const p=()=>localStorage.setItem(`chat-${k}`,el.value);
  el.addEventListener('change',p);el.addEventListener('input',p);
});
$('#temp-val').textContent=$('#cfg-temp').value;
$('#tokens-val').textContent=$('#cfg-maxtokens').value;

function getCfg(){return{
  endpoint:($('#cfg-endpoint').value||'').replace(/\/$/,''),
  apiKey:$('#cfg-apikey').value||'',
  model:localStorage.getItem('chat-model')||'global.anthropic.claude-opus-4-6-v1',
  system:$('#cfg-system').value||'',
  maxTokens:Math.min(parseInt($('#cfg-maxtokens').value)||4096,65536),
  temperature:parseFloat($('#cfg-temp').value),
};}

function toggleSettings(){$('#settings').classList.toggle('hidden');$('#settings-backdrop').classList.toggle('hidden');}
function toggleSidebar(){$('#sidebar').classList.toggle('-translate-x-full');$('#sidebar-overlay').classList.toggle('hidden');}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    if(!$('#settings').classList.contains('hidden'))toggleSettings();
    if(!$('#model-picker').classList.contains('hidden'))closeModelPicker();
    if(!$('#delete-modal').classList.contains('hidden'))cancelDelete();
    if(!$('#delete-all-modal').classList.contains('hidden'))cancelDeleteAll();
  }
});
if(!localStorage.getItem('chat-endpoint')||!localStorage.getItem('chat-apikey'))toggleSettings();

// â”€â”€ Model Picker â”€â”€
function updateModelLabel(){const m=localStorage.getItem('chat-model');$('#model-label').textContent=m||'Select model';$('#model-label').title=m||'';}
updateModelLabel();
function toggleModelPicker(){const p=$('#model-picker');if(p.classList.contains('hidden')){p.classList.remove('hidden');$('#model-search').value='';filterModels();$('#model-search').focus();}else closeModelPicker();}
function closeModelPicker(){$('#model-picker').classList.add('hidden');}
document.addEventListener('click',e=>{if(!$('#model-picker').contains(e.target)&&!$('#model-btn').contains(e.target))closeModelPicker();});
function selectModel(id){localStorage.setItem('chat-model',id);updateModelLabel();closeModelPicker();}
function filterModels(){
  const q=$('#model-search').value.toLowerCase(),filtered=allModels.filter(m=>m.toLowerCase().includes(q)),current=localStorage.getItem('chat-model'),list=$('#model-list');
  list.innerHTML='';
  if(!filtered.length){list.innerHTML='<div class="p-4 text-center text-sm text-zinc-600">No models found</div>';return;}
  filtered.forEach(id=>{const d=document.createElement('div'),a=id===current;d.className=`model-option${a?' active bg-surface-3':''}`;
    d.innerHTML=`<div class="flex items-center justify-between gap-2"><span class="truncate ${a?'text-accent font-medium':'text-zinc-300'}">${esc(id)}</span>${a?'<span class="text-accent text-xs flex-shrink-0">âœ“</span>':''}</div>`;
    d.onclick=()=>selectModel(id);list.appendChild(d);});
}
async function fetchModels(){
  const{endpoint,apiKey}=getCfg();if(!endpoint||!apiKey)return;
  try{const res=await fetch(`${endpoint}/models`,{headers:{'Authorization':`Bearer ${apiKey}`}});if(!res.ok)throw 0;
    const json=await res.json();allModels=(json.data||[]).map(m=>m.id).sort();
    if(!localStorage.getItem('chat-model')&&allModels.length){localStorage.setItem('chat-model',allModels.find(m=>m.includes('opus-4-6'))||allModels.find(m=>m.includes('claude'))||allModels[0]);}
    updateModelLabel();
  }catch{console.error('Failed to fetch models');}
}

// â”€â”€ Files â”€â”€
function handleFiles(fl){for(const f of fl){const r=new FileReader();if(f.type.startsWith('image/')){r.onload=()=>{pendingFiles.push({name:f.name,content:r.result,type:'image'});renderAttachments();};r.readAsDataURL(f);}else{r.onload=()=>{pendingFiles.push({name:f.name,content:r.result,type:'text'});renderAttachments();};r.readAsText(f);}}$('#file-input').value='';}
function removeFile(i){pendingFiles.splice(i,1);renderAttachments();}
function renderAttachments(){const c=$('#attachment-list'),w=$('#attachments');if(!pendingFiles.length){w.classList.add('hidden');c.innerHTML='';return;}w.classList.remove('hidden');c.innerHTML=pendingFiles.map((f,i)=>`<div class="file-chip">${f.type==='image'?'ðŸ–¼':'ðŸ“„'} ${esc(f.name)}<button onclick="removeFile(${i})" class="ml-1 text-zinc-600 hover:text-red-400 text-sm">&times;</button></div>`).join('');}
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',e=>{e.preventDefault();if(e.dataTransfer.files.length)handleFiles(e.dataTransfer.files);});

// â”€â”€ Chats â”€â”€
function saveChats(){
  // Strip heavy data (base64 images, file contents) before persisting to avoid localStorage quota
  const lite=chats.map(c=>({...c,messages:c.messages.map(m=>{
    const clean={role:m.role,content:m.content};
    // Keep file metadata (name/type) but drop the actual content for display reference
    if(m.files)clean.files=m.files.map(f=>({name:f.name,type:f.type}));
    // Don't persist .images (base64 data) â€” too large for localStorage
    return clean;
  })}));
  try{localStorage.setItem('chats',JSON.stringify(lite));}catch(e){console.warn('localStorage full, skipping save',e);}
  localStorage.setItem('activeChatId',activeChatId);
}
function getChat(){return chats.find(c=>c.id===activeChatId)||null;}
function pushChatUrl(id){if(id)history.pushState({chatId:id},'','/c/'+id);else history.replaceState(null,'','/');}
function replaceChatUrl(id){if(id)history.replaceState({chatId:id},'','/c/'+id);else history.replaceState(null,'','/');}
function newChat(force){const cur=getChat();if(!force&&cur&&cur.messages.filter(m=>m.role!=='system').length===0){$('#input').focus();return;}autoTitleChat(cur);const c={id:crypto.randomUUID(),title:'New chat',messages:[],created:Date.now()};chats.unshift(c);activeChatId=c.id;saveChats();renderChatList();renderMessages();pushChatUrl(c.id);$('#input').focus();if(window.innerWidth<640)toggleSidebar();}
function deleteChat(id,e){e.stopPropagation();pendingDeleteId=id;$('#delete-modal').classList.remove('hidden');$('#delete-backdrop').classList.remove('hidden');}
function cancelDelete(){pendingDeleteId=null;$('#delete-modal').classList.add('hidden');$('#delete-backdrop').classList.add('hidden');}
function confirmDelete(){if(!pendingDeleteId)return;chats=chats.filter(c=>c.id!==pendingDeleteId);if(activeChatId===pendingDeleteId){activeChatId=chats[0]?.id||null;replaceChatUrl(activeChatId);}cancelDelete();saveChats();renderChatList();renderMessages();}
function selectChat(id){if(id===activeChatId)return;autoTitleChat(getChat());activeChatId=id;saveChats();renderChatList();renderMessages();pushChatUrl(id);if(window.innerWidth<640)toggleSidebar();}

// â”€â”€ Delete All Chats â”€â”€
function showDeleteAllModal(){
  toggleSettings(); // close settings first
  $('#delete-all-modal').classList.remove('hidden');$('#delete-all-backdrop').classList.remove('hidden');
}
function cancelDeleteAll(){$('#delete-all-modal').classList.add('hidden');$('#delete-all-backdrop').classList.add('hidden');}
function confirmDeleteAll(){
  chats=[];activeChatId=null;cancelDeleteAll();saveChats();renderChatList();renderMessages();
  newChat(true); // start fresh
}

function autoTitleChat(chat){
  if(!chat||chat.title!=='New chat'||chat.messages.length<2)return;
  const u=chat.messages.filter(m=>m.role==='user'),a=chat.messages.filter(m=>m.role==='assistant');
  if(!u.length)return;const q=u[0].content.replace(/\n/g,' ').slice(0,60);
  chat.title=q.length>40?q.slice(0,40)+'â€¦':q;
  if(a.length){const m=a[0].content.slice(0,200).match(/^(?:#+ )?(.{10,50}?)(?:[.!?\n]|$)/);if(m){const c=m[1].replace(/^[#*\s]+/,'').trim();if(c.length>10)chat.title=c.slice(0,42)+(c.length>42?'â€¦':'');}}
  saveChats();renderChatList();
}
function renderChatList(){
  const el=$('#chat-list');el.innerHTML='';
  chats.forEach(chat=>{const d=document.createElement('div');
    d.className=`group flex items-center gap-2 px-3 py-2.5 rounded-xl cursor-pointer transition text-[13px] ${chat.id===activeChatId?'bg-surface-3 text-zinc-100':'text-zinc-500 hover:bg-surface-2 hover:text-zinc-300'}`;
    d.onclick=()=>selectChat(chat.id);
    d.innerHTML=`<svg class="w-4 h-4 flex-shrink-0 ${chat.id===activeChatId?'text-accent':'text-zinc-600'}" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z"/></svg>
      <span class="flex-1 truncate">${esc(chat.title)}</span>
      <button onclick="deleteChat('${chat.id}',event)" class="hidden group-hover:flex w-6 h-6 items-center justify-center rounded-md text-zinc-600 hover:text-red-400 hover:bg-surface-4 transition text-xs">âœ•</button>`;
    el.appendChild(d);});
}

// â”€â”€ Rendering â”€â”€
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function renderMarkdown(text){const raw=marked.parse(text),clean=DOMPurify.sanitize(raw,{ADD_ATTR:['class','target'],ALLOW_DATA_ATTR:false}),w=document.createElement('div');w.innerHTML=clean;w.querySelectorAll('pre').forEach(pre=>{const code=pre.querySelector('code'),lang=code?.className?.match(/language-(\w+)/)?.[1]||'',hdr=document.createElement('div');hdr.className='code-header';hdr.innerHTML=`<span>${lang||'code'}</span><button class="copy-btn" onclick="copyCode(this)">Copy</button>`;pre.insertBefore(hdr,pre.firstChild);});return w.innerHTML;}
function copyCode(btn){const pre=btn.closest('pre');const code=pre.querySelector('code');navigator.clipboard.writeText(code.textContent);btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy',1500);}

function renderMessages(){
  const chat=getChat(),el=$('#messages');el.innerHTML='';lastStopReason=null;
  if(!chat||!chat.messages.filter(m=>m.role!=='system').length){
    el.innerHTML=`<div class="h-full flex flex-col items-center justify-center gap-4 px-4">
      <div class="w-14 h-14 rounded-2xl bg-accent/10 flex items-center justify-center"><svg class="w-7 h-7 text-accent/60" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg></div>
      <div class="text-center"><p class="text-zinc-400 text-[15px] font-medium">How can I help?</p><p class="text-zinc-600 text-sm mt-1">Ask anything or drop a file</p></div></div>`;
    return;}
  chat.messages.forEach((msg,idx)=>{if(msg.role==='system')return;appendMessageEl(msg.role,msg.content,msg.files,idx);});
  el.scrollTop=el.scrollHeight;
}

function appendMessageEl(role,text,files,msgIdx){
  const el=$('#messages'),empty=el.querySelector('.flex.flex-col.items-center');if(empty)empty.remove();
  const row=document.createElement('div');row.className=`message-row py-4 sm:py-5 fade-in ${role==='assistant'?'bg-surface/40':''}`;
  const inner=document.createElement('div');inner.className='max-w-[740px] mx-auto px-4 sm:px-5 flex gap-3';
  const avatar=document.createElement('div');avatar.className=`w-7 h-7 rounded-lg flex items-center justify-center text-[11px] font-bold flex-shrink-0 mt-0.5 ${role==='user'?'bg-accent text-white':'bg-surface-3 text-zinc-400 border border-border'}`;avatar.textContent=role==='user'?'U':'AI';
  const content=document.createElement('div');content.className='flex-1 min-w-0';
  if(files?.length){const fd=document.createElement('div');fd.className='flex flex-wrap gap-2 mb-2';files.forEach(f=>{if(f.type==='image'){const img=document.createElement('img');img.src=f.content;img.className='max-w-[200px] max-h-36 rounded-xl border border-border';fd.appendChild(img);}else{const c=document.createElement('span');c.className='file-chip';c.textContent=`ðŸ“„ ${f.name}`;fd.appendChild(c);}});content.appendChild(fd);}
  const textDiv=document.createElement('div');textDiv.className='text-[14px] leading-[1.7] break-words';
  if(role==='assistant'){textDiv.className+=' md-content';textDiv.innerHTML=renderMarkdown(text);}else{textDiv.className+=' whitespace-pre-wrap text-zinc-300';textDiv.textContent=text;}
  content.appendChild(textDiv);
  if(msgIdx!==undefined&&!streaming){const actions=document.createElement('div');actions.className='msg-actions mt-1.5 flex gap-1';
    if(role==='user')actions.innerHTML=`<button onclick="editMessage(${msgIdx})" class="text-[11px] text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded-lg hover:bg-surface-3 transition">âœŽ Edit</button>`;
    if(role==='assistant')actions.innerHTML=`<button onclick="copyMessage(${msgIdx})" class="text-[11px] text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded-lg hover:bg-surface-3 transition">âŽ˜ Copy</button><button onclick="regenerate(${msgIdx})" class="text-[11px] text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded-lg hover:bg-surface-3 transition">â†» Regenerate</button>`;
    content.appendChild(actions);}
  inner.appendChild(avatar);inner.appendChild(content);row.appendChild(inner);el.appendChild(row);
  if(autoScrollEnabled)el.scrollTop=el.scrollHeight;
  return textDiv;
}

// â”€â”€ Actions â”€â”€
function editMessage(idx){const chat=getChat();if(!chat)return;$('#input').value=chat.messages[idx].content;$('#input').focus();$('#input').style.height='auto';$('#input').style.height=Math.min($('#input').scrollHeight,160)+'px';chat.messages=chat.messages.slice(0,idx);saveChats();renderMessages();}
function copyMessage(idx){const chat=getChat();if(chat)navigator.clipboard.writeText(chat.messages[idx].content);}
function regenerate(idx){const chat=getChat();if(!chat||streaming)return;chat.messages=chat.messages.slice(0,idx);saveChats();renderMessages();doStream(chat);}

// â”€â”€ Continue generating â”€â”€
function continueGenerating(){
  const chat=getChat();if(!chat||streaming)return;
  // Add a user message asking to continue
  chat.messages.push({role:'user',content:'Please continue generating from where you left off.'});
  saveChats();renderChatList();appendMessageEl('user','Please continue generating from where you left off.',null,chat.messages.length-1);
  doStream(chat);
}

// â”€â”€ Send / Stop â”€â”€
const inputEl=$('#input');
inputEl.addEventListener('input',()=>{inputEl.style.height='auto';inputEl.style.height=Math.min(inputEl.scrollHeight,160)+'px';});
inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendClick();}});
inputEl.addEventListener('paste',e=>{const items=e.clipboardData?.items;if(!items)return;for(const item of items){if(item.type.startsWith('image/')){e.preventDefault();handleFiles([item.getAsFile()]);}}});

function handleSendClick(){if(streaming)stopStreaming();else send();}
function setStreamingUI(on){streaming=on;$('#send-icon').classList.toggle('hidden',on);$('#stop-icon').classList.toggle('hidden',!on);$('#send-btn').classList.toggle('bg-accent',!on);$('#send-btn').classList.toggle('bg-red-600',on);}
function stopStreaming(){if(abortController)abortController.abort();setStreamingUI(false);}

async function send(){
  const text=inputEl.value.trim();if(!text&&!pendingFiles.length)return;
  const{endpoint,apiKey,system}=getCfg();if(!endpoint||!apiKey){toggleSettings();return;}
  if(endpoint&&!endpoint.startsWith('https://')){alert('Please use an HTTPS endpoint for security.');toggleSettings();return;}
  if(!getChat())newChat(true);const chat=getChat();
  if(chat.messages.length===0&&system)chat.messages.push({role:'system',content:system});
  let userContent=text;const msgFiles=[...pendingFiles];const MAX_INPUT_LENGTH=100000;
  if(userContent.length>MAX_INPUT_LENGTH){alert(`Message too long (${userContent.length} chars). Max is ${MAX_INPUT_LENGTH}.`);return;}
  const textFiles=msgFiles.filter(f=>f.type==='text');
  const imageFiles=msgFiles.filter(f=>f.type==='image');
  if(textFiles.length){const tp=textFiles.map(f=>`--- ${f.name} ---\n${f.content}\n--- end ---`);userContent=[...tp,text].filter(Boolean).join('\n\n');}
  // Store display content as string, keep image data URLs in .images for API calls
  chat.messages.push({role:'user',content:userContent||(imageFiles.length?'(image attached)':''),files:msgFiles.length?msgFiles:undefined,images:imageFiles.length?imageFiles.map(f=>f.content):undefined});
  if(chat.messages.filter(m=>m.role==='user').length===1)chat.title=(text||msgFiles[0]?.name||'New chat').slice(0,50);
  saveChats();renderChatList();appendMessageEl('user',text||'(files attached)',msgFiles,chat.messages.length-1);
  inputEl.value='';inputEl.style.height='auto';pendingFiles=[];renderAttachments();
  await doStream(chat);
}

async function doStream(chat){
  const{endpoint,apiKey,model,maxTokens,temperature}=getCfg();setStreamingUI(true);
  userScrolledAway=false;autoScrollEnabled=true;lastStopReason=null;
  const contentEl=appendMessageEl('assistant','',null,chat.messages.length);
  const cursor=document.createElement('span');cursor.className='inline-block w-0.5 h-4 bg-accent cursor-blink align-text-bottom ml-px';contentEl.appendChild(cursor);
  let fullText='';abortController=new AbortController();
  try{
    const res=await fetch(`${endpoint}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${getCfg().apiKey}`},
      body:JSON.stringify({model,messages:chat.messages.map(m=>{
        // Build multimodal content array if message has images
        if(m.images&&m.images.length){
          const parts=m.images.map(dataUrl=>({type:'image_url',image_url:{url:dataUrl}}));
          if(m.content)parts.push({type:'text',text:m.content});
          return{role:m.role,content:parts};
        }
        return{role:m.role,content:m.content};
      }),max_tokens:maxTokens,temperature,stream:true}),signal:abortController.signal});
    if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error?.message||`HTTP ${res.status}`);}
    const reader=res.body.getReader(),decoder=new TextDecoder();let buffer='';
    while(true){const{done,value}=await reader.read();if(done)break;buffer+=decoder.decode(value,{stream:true});const lines=buffer.split('\n');buffer=lines.pop();
      for(const line of lines){if(!line.startsWith('data: '))continue;const data=line.slice(6);if(data==='[DONE]')break;
        try{const parsed=JSON.parse(data);const choice=parsed.choices?.[0];const delta=choice?.delta?.content;
          if(choice?.finish_reason==='length')lastStopReason='length';
          if(delta){fullText+=delta;contentEl.innerHTML=renderMarkdown(fullText);contentEl.appendChild(cursor);
            if(autoScrollEnabled)$('#messages').scrollTop=$('#messages').scrollHeight;}}catch{}}}
  }catch(err){if(err.name!=='AbortError'){contentEl.textContent=`Error: ${err.message}`;contentEl.classList.add('text-red-400');cursor.remove();setStreamingUI(false);return;}}
  cursor.remove();
  if(fullText){
    contentEl.innerHTML=renderMarkdown(fullText);
    chat.messages.push({role:'assistant',content:fullText});saveChats();
    // Show continue button if stopped due to token limit
    if(lastStopReason==='length'){
      const continueBtn=document.createElement('button');
      continueBtn.className='continue-btn';
      continueBtn.innerHTML='<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg> Continue generating';
      continueBtn.onclick=()=>{continueBtn.remove();continueGenerating();};
      contentEl.appendChild(continueBtn);
    }
  }
  setStreamingUI(false);abortController=null;inputEl.focus();
  updateScrollBtn();
}

// â”€â”€ Init: always open a new chat on page load â”€â”€
function initApp(){
  renderChatList();
  // Check if URL has a chat ID to restore
  const pathMatch=location.pathname.match(/^\/c\/([a-f0-9-]+)$/i);
  if(pathMatch){
    const urlChatId=pathMatch[1];
    const found=chats.find(c=>c.id===urlChatId);
    if(found){activeChatId=urlChatId;saveChats();renderChatList();renderMessages();replaceChatUrl(urlChatId);}
    else{newChat(true);} // chat not found locally, start fresh
  }else{
    newChat(true);
  }
  if(localStorage.getItem('chat-endpoint')&&localStorage.getItem('chat-apikey'))fetchModels();
  setTimeout(()=>$('#input').focus(),100);
}
// Handle browser back/forward
window.addEventListener('popstate',e=>{
  const id=e.state?.chatId;
  if(id&&chats.find(c=>c.id===id)){activeChatId=id;saveChats();renderChatList();renderMessages();}
  else{newChat(true);}
});
initApp();
</script>
</body>
</html>
